"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.AwsV4Signer=void 0;var _slicedToArray=function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var s=[],i=!0,r=!1,a=void 0;try{for(var n,o=e[Symbol.iterator]();!(i=(n=o.next()).done)&&(s.push(n.value),!t||s.length!==t);i=!0);}catch(e){r=!0,a=e}finally{try{!i&&o.return&&o.return()}finally{if(r)throw a}}return s}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")},_createClass=function(){function i(e,t){for(var s=0;s<t.length;s++){var i=t[s];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(e,t,s){return t&&i(e.prototype,t),s&&i(e,s),e}}();require("../polyfills/textencoder.js");var _URL=require("../polyfills/URL.js"),_URL2=_interopRequireDefault(_URL),_headers=require("../polyfills/headers.js"),_headers2=_interopRequireDefault(_headers),_awsSdkReactNative=require("../lib/aws-sdk-react-native.js"),_awsSdkReactNative2=_interopRequireDefault(_awsSdkReactNative);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,s=Array(e.length);t<e.length;t++)s[t]=e[t];return s}return Array.from(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var encoder=new global.TextEncoder("utf-8"),HOST_SERVICES={appstream2:"appstream",cloudhsmv2:"cloudhsm",email:"ses","git-codecommit":"codecommit",marketplace:"aws-marketplace",mobile:"AWSMobileHubService","mturk-requester-sandbox":"mturk-requester",pinpoint:"mobiletargeting",queue:"sqs"},UNSIGNABLE_HEADERS=["authorization","content-type","content-length","user-agent","presigned-expires","expect","x-amzn-trace-id"],AwsV4Signer=exports.AwsV4Signer=function(){function w(e){var s=this,t=e.method,i=e.url,r=e.headers,a=e.body,n=e.accessKeyId,o=e.secretAccessKey,c=e.sessionToken,h=e.service,u=e.region,l=e.cache,d=e.datetime,f=e.signQuery,p=e.appendSessionToken,g=e.allHeaders,m=e.singleEncode;if(_classCallCheck(this,w),null==i)throw new TypeError("url is a required option");if(null==n)throw new TypeError("accessKeyId is a required option");if(null==o)throw new TypeError("secretAccessKey is a required option");this.method=t||(a?"POST":"GET"),this.url=new _URL2.default(i),this.headers=new _headers2.default(r),this.body=a,this.accessKeyId=n,this.secretAccessKey=o,this.sessionToken=c;var y=void 0,S=void 0;if(!h||!u){var v=guessServiceRegion(this.url,this.headers),A=_slicedToArray(v,2);y=A[0],S=A[1]}this.service=h||y,this.region=u||S,this.cache=l||new Map,this.datetime=d||(new Date).toISOString().replace(/[:-]|\.\d{3}/g,""),this.signQuery=f,this.appendSessionToken=p||"iotdevicegateway"===this.service,this.headers.delete("Host");var _=this.signQuery?this.url.searchParams:this.headers;"s3"!==this.service||this.headers.has("X-Amz-Content-Sha256")||this.headers.set("X-Amz-Content-Sha256","UNSIGNED-PAYLOAD"),_.set("X-Amz-Date",this.datetime),this.sessionToken&&!this.appendSessionToken&&_.set("X-Amz-Security-Token",this.sessionToken),this.signableHeaders=["host"].concat(_toConsumableArray(this.headers.keys())).filter(function(e){return g||!UNSIGNABLE_HEADERS.includes(e)}).sort(),this.signedHeaders=this.signableHeaders.join(";"),this.canonicalHeaders=this.signableHeaders.map(function(e){return e+":"+("host"===e?s.url.host:s.headers.get(e).replace(/\s+/g," "))}).join("\n"),this.credentialString=[this.datetime.slice(0,8),this.region,this.service,"aws4_request"].join("/"),this.signQuery&&("s3"!==this.service||_.has("X-Amz-Expires")||_.set("X-Amz-Expires",86400),_.set("X-Amz-Algorithm","AWS4-HMAC-SHA256"),_.set("X-Amz-Credential",this.accessKeyId+"/"+this.credentialString),_.set("X-Amz-SignedHeaders",this.signedHeaders)),this.encodedPath="s3"===this.service?decodeURIComponent(this.url.pathname):this.url.pathname.replace(/\/+/g,"/"),m||(this.encodedPath=encodeURIComponent(this.encodedPath).replace(/%2F/g,"/"));var k=new Set;this.encodedSearch=[].concat(_toConsumableArray(this.url.searchParams)).filter(function(e){var t=_slicedToArray(e,1)[0];if(!t)return!1;if("s3"===s.service){if(k.has(t))return!1;k.add(t)}return!0}).map(function(e){return e.map(encodeURIComponent).join("=")}).sort().join("&")}return _createClass(w,[{key:"sign",value:function(){return this.signQuery?(this.url.searchParams.set("X-Amz-Signature",this.signature()),this.sessionToken&&this.appendSessionToken&&this.url.searchParams.set("X-Amz-Security-Token",this.sessionToken)):this.headers.set("Authorization",this.authHeader()),{method:this.method,url:this.url,headers:this.headers,body:this.body}}},{key:"authHeader",value:function(){return["AWS4-HMAC-SHA256 Credential="+this.accessKeyId+"/"+this.credentialString,"SignedHeaders="+this.signedHeaders,"Signature="+this.signature()].join(", ")}},{key:"signature",value:function(){var e=this.datetime.slice(0,8),t=[this.secretAccessKey,e,this.region,this.service].join(),s=this.cache.get(t);if(!s){var i=_awsSdkReactNative2.default.util.crypto.hmac("AWS4"+this.secretAccessKey,e,"buffer"),r=_awsSdkReactNative2.default.util.crypto.hmac(i,this.region,"buffer"),a=_awsSdkReactNative2.default.util.crypto.hmac(r,this.service,"buffer");s=_awsSdkReactNative2.default.util.crypto.hmac(a,"aws4_request","buffer"),this.cache.set(t,s)}return _awsSdkReactNative2.default.util.crypto.hmac(s,this.stringToSign(),"hex")}},{key:"stringToSign",value:function(){return["AWS4-HMAC-SHA256",this.datetime,this.credentialString,hash(this.canonicalString(),"hex")].join("\n")}},{key:"canonicalString",value:function(){return[this.method,encodeRfc3986(this.encodedPath),encodeRfc3986(this.encodedSearch),this.canonicalHeaders+"\n",this.signedHeaders,this.hexBodyHash()].join("\n")}},{key:"hexBodyHash",value:function(){return this.headers.has("X-Amz-Content-Sha256")?this.headers.get("X-Amz-Content-Sha256"):hash(this.body||"","hex")}},{key:"signMqttOverSocket",value:function(){var e=this.sign().url,t=e.protocol+"//";t+=e.host,t+=e.pathname+"?";for(var s=e.searchParams.entries(),i=s.next().value;t+=i[0]+"="+encodeURIComponent(i[1])+"&",i=s.next().value;);return t}}]),w}();function hash(e,t){return _awsSdkReactNative2.default.util.crypto.sha256(e,t)}function encodeRfc3986(e){return e.replace(/[!'()*]/g,function(e){return"%"+e.charCodeAt(0).toString(16).toUpperCase()})}function guessServiceRegion(e,t){var s=e.hostname,i=e.pathname,r=(s.replace("dualstack.","").match(/([^.]+)\.(?:([^.]*)\.)?amazonaws\.com(?:\.cn)?$/)||["",""]).slice(1,3),a=_slicedToArray(r,2),n=a[0],o=a[1];if("us-gov"===o)o="us-gov-west-1";else if("s3"===o||"s3-accelerate"===o)o="us-east-1",n="s3";else if("iot"===n)n=s.startsWith("iot.")?"execute-api":s.startsWith("data.jobs.iot.")?"iot-jobs-data":"/mqtt"===i?"iotdevicegateway":"iotdata";else if("autoscaling"===n){var c=(t.get("X-Amz-Target")||"").split(".")[0];"AnyScaleFrontendService"===c?n="application-autoscaling":"AnyScaleScalingPlannerFrontendService"===c&&(n="autoscaling-plans")}else if(null==o&&n.startsWith("s3-"))o=n.slice(3).replace(/^fips-|^external-1/,""),n="s3";else if(n.endsWith("-fips"))n=n.slice(0,-5);else if(o&&/-\d$/.test(n)&&!/-\d$/.test(o)){var h=[o,n];n=h[0],o=h[1]}return[HOST_SERVICES[n]||n,o||"us-east-1"]}