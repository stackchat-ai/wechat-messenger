"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function s(e,t){for(var r=0;r<t.length;r++){var s=t[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(e,t,r){return t&&s(e.prototype,t),r&&s(e,r),e}}();function _defineProperty(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var assign=require("../../npm/object-assign/index.js"),EventTarget=require("../../npm/event-target-shim/lib/event-target.js"),FormData=require("./formdata.js"),UNSENT=0,OPENED=1,HEADERS_RECEIVED=2,LOADING=3,DONE=4,REQUEST_EVENTS=["abort","error","load","loadstart","progress","timeout","loadend","readystatechange"],REQUEST_UPLOAD_EVENTS=["abort","error","load","loadstart","progress","timeout","loadend"];function successCallback(r){this.status=r.statusCode,this.statusText=r.statusCode,r.header&&(this._responseHeaders=Object.keys(r.header).reduce(function(e,t){return e[t.toLowerCase()]=r.header[t],e},{})),"string"==typeof r.data?this.responseType="text":this.responseType="json",this.responseText=JSON.stringify(r.data),this.response=r.data,this.readyState=DONE,this.dispatchEvent({type:"readystatechange"})}var XMLHttpRequestUpload=function(){function e(){return _classCallCheck(this,e),_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return _inherits(e,EventTarget(REQUEST_UPLOAD_EVENTS)),e}(),XMLHttpRequest=exports.XMLHttpRequest=function(){function t(){_classCallCheck(this,t);var e=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e.UNSENT=UNSENT,e.OPENED=OPENED,e.HEADERS_RECEIVED=HEADERS_RECEIVED,e.LOADING=LOADING,e.DONE=DONE,e.readyState=UNSENT,e._headers={},e.upload=new XMLHttpRequestUpload,e}return _inherits(t,EventTarget(REQUEST_EVENTS)),_createClass(t,[{key:"abort",value:function(){if(!this._request||this._request.abort)return this.status=0,this.readyState=DONE,this._request.abort();throw new Error("该版本基础库不支持 abort request")}},{key:"getAllResponseHeaders",value:function(){var t=this;return this._responseHeaders?Object.keys(this._responseHeaders).map(function(e){return e+": "+t._responseHeaders[e]}).join("\r\n"):""}},{key:"getResponseHeader",value:function(e){var t=e.toLowerCase();return this._responseHeaders&&this._responseHeaders[t]?this._responseHeaders[t]:null}},{key:"overrideMimeType",value:function(){throw new Error("not supported in weapp")}},{key:"open",value:function(e,t,r){var s=!(2<arguments.length&&void 0!==r)||r;if(this.readyState!==UNSENT)throw new Error("request is already opened");if(!s)throw new Error("sync request is not supported");this._method=e,this._url=t,this.readyState=OPENED,this.dispatchEvent({type:"readystatechange"})}},{key:"setRequestHeader",value:function(e,t){if(this.readyState!==OPENED)throw new Error("request is not opened");this._headers[e.toLowerCase()]=t}},{key:"send",value:function(e){var s=this;if(this.readyState!==OPENED)throw new Error("request is not opened");if(e instanceof FormData){var t=e.entries(),r=t.filter(function(e){return"string"!=typeof e[1]});if(0===r.length)throw new Error("Must specify a Blob field in FormData");1<r.length&&console.warn("Only the first Blob will be send in Weapp");var n=t.filter(function(e){return"string"==typeof e[1]}).reduce(function(e,t){return assign(e,_defineProperty({},t[0],t[1]))},{});this._request=wx.uploadFile({url:this._url,name:r[0][0],filePath:r[0][1].uri,formData:n,header:this._headers,success:successCallback.bind(this),fail:function(e){s.status=0,s.readyState=DONE,s.dispatchEvent({type:"readystatechange"}),s.dispatchEvent({type:"error"})}}),this._request&&this._request.onProgressUpdate&&this._request.onProgressUpdate(function(e){var t=e.totalBytesSent,r=e.totalBytesExpectedToSend;s.upload.dispatchEvent({type:"progress",loaded:t,total:r})})}else this._request=wx.request({url:this._url,data:e||"",method:this._method.toUpperCase(),header:this._headers,success:successCallback.bind(this),fail:function(e){s.status=0,s.readyState=DONE,s.dispatchEvent({type:"readystatechange"}),s.dispatchEvent({type:"error"})}})}}]),t}();assign(XMLHttpRequest,{UNSENT:UNSENT,OPENED:OPENED,HEADERS_RECEIVED:HEADERS_RECEIVED,LOADING:LOADING,DONE:DONE});