"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(e[o]=n[o])}return e};exports.subscribeIot=subscribeIot,exports.disconnectIot=disconnectIot,exports.reconnectIot=reconnectIot;var _appState=require("./app-state.js"),_conversation=require("./conversation.js"),_app=require("../constants/app.js"),_index=require("../store/index.js"),_connectionState=require("../constants/connection-state.js"),_applyPseudoStaticIds=require("../../utils/applyPseudoStaticIds.js"),_awsSdkReactNative=require("../../lib/aws-sdk-react-native.js"),_awsSdkReactNative2=_interopRequireDefault(_awsSdkReactNative),_AwsV4Signer=require("../../utils/AwsV4Signer.js"),_index2=require("../../lib/mqttjs/index.js"),_index3=_interopRequireDefault(_index2);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var client=null,connectionInProgress=!1,connectionPromise=null,isReconnecting=!1,reconnectionPromise=null;function subscribeIot(){var r=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0;if(isReconnecting)return reconnectionPromise;if(connectionInProgress)return connectionPromise;var a=_index.store.dispatch,e=(0,_index.store.getState)(),c=e.config.realtime,t=e.user.id;return e.appState.connectionState===_connectionState.CONNECTION_STATE.CONNECTED&&client?Promise.resolve():connectionPromise=new Promise(function(s,e){return t?getClient().then(function(e){connectionInProgress=!0,(client=e).subscribe(""+t,{qos:1},function(e){if(e){var t=c.retryInterval,n=void 0===t?15:t,o=c.maxConnectionAttempts,i=r<(void 0===o?5:o)-1&&401===e.code&&"Unknown client"===e.message;if(i?_index.store.dispatch((0,_appState.setConnectionState)(_connectionState.CONNECTION_STATE.DISCONNECTED_WITH_RETRY)):_index.store.dispatch((0,_appState.setConnectionState)(_connectionState.CONNECTION_STATE.DISCONNECTED)),!i)throw connectionInProgress=!1,connectionPromise=null,Object.assign(new Error(e.message),_extends({},e,{reattemptCount:r}));disconnectIot(),setTimeout(function(){subscribeIot(++r).then(function(){s()})},0===r?0:1e3*n)}else connectionPromise=null,connectionInProgress=!1,s(),wx.onSocketError(function(e){console.log(e,"error"),reconnectIot()}),client.on("message",function(e,t){var n=JSON.parse(t.toString());n.message.items&&0<n.message.items.length&&(0,_applyPseudoStaticIds.applyPseudoStaticIds)(n.message);var o=[_extends({type:"message"},n)],i=o.filter(function(e){return"message"===e.type}),s=o.filter(function(e){return"activity"===e.type}),r=o.filter(function(e){return e.type.startsWith("link")}),c=o.filter(function(e){return e.type.startsWith("upload")});0<i.length&&a(handleMessageEvents(i)),0<s.length&&a(handleActivityEvents(s)),0<r.length&&a(handleLinkEvents(r)),0<c.length&&a(handleUploadEvents(c)),connectionInProgress&&_index.store.dispatch((0,_appState.setConnectionState)(_connectionState.CONNECTION_STATE.CONNECTED))})})}):e()})}function disconnectIot(){return new Promise(function(e){client&&(client.end(),setTimeout(function(){client=null,e()},1500))})}function reconnectIot(){return isReconnecting=!0,reconnectionPromise=new Promise(function(e){disconnectIot().then(function(){isReconnecting=!1,reconnectionPromise=null,subscribeIot().then(function(){e()})})})}function getClient(){if(client)return Promise.resolve(client);var e=_index.store.getState(),t=e.config,n=e.user,o="wxs://"+t.brokerUrl;try{return _awsSdkReactNative2.default.config.credentials.getPromise().then(function(){return(client=(0,_index3.default)(o,{clientId:n.id,transformWsUrl:function(e,t){return new _AwsV4Signer.AwsV4Signer({url:"wss://"+t.host+"/mqtt",accessKeyId:_awsSdkReactNative2.default.config.credentials.accessKeyId,secretAccessKey:_awsSdkReactNative2.default.config.credentials.secretAccessKey,sessionToken:_awsSdkReactNative2.default.config.credentials.sessionToken,region:_awsSdkReactNative2.default.config.region,service:"iotdevicegateway",appendSessionToken:!0,signQuery:!0}).signMqttOverSocket()},protocolId:"MQIsdp",protocolVersion:3,wsOptions:{port:443}})).on("offline",function(){_index.store.dispatch((0,_appState.setConnectionState)(_connectionState.CONNECTION_STATE.DISCONNECTED_WITH_RETRY))}),client.on("connect",function(){_index.store.dispatch((0,_appState.setConnectionState)(_connectionState.CONNECTION_STATE.CONNECTED))}),client})}catch(e){console.log(e)}}function handleMessageEvents(u){return function(n,e){var t=e(),o=(t.config.appId,t.conversation),i=o.id,s=(o.messages,t.ui.isAtBottom),r=t.appState,c=r.widgetState,a=r.settingsVisible;u.filter(function(e){return e.conversation.id===i}).forEach(function(e){var t=e.message;return n((0,_conversation.addMessage)(t)),"endUser"===t.role?n((0,_conversation.resetUnreadCount)()):c!==_app.WIDGET_STATE.OPENED&&c!==_app.WIDGET_STATE.EMBEDDED||a||!s?void n((0,_conversation.incrementUnreadCount)()):n((0,_conversation.resetUnreadCount)())})}}function handleActivityEvents(n){return function(r,e){var c=e().conversation,t=c.id;n.filter(function(e){return e.conversation.id===t}).forEach(function(e){var t=e.activity,n=t.type,o=t.role,i=t.data,s=e.conversation;if("businessSystem"===o)switch(n){case"typing:start":return r((0,_appState.showTypingIndicator)(i));case"typing:stop":return r((0,_appState.hideTypingIndicator)());case"conversation:read":return c.appMakerLastRead=s.appMakerLastRead,r((0,_conversation.setConversation)(c))}})}}