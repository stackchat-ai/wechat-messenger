"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.EDITABLE_PROPERTIES=exports.UPDATE_PENDING_USER_PROPS=exports.RESET_PENDING_USER_PROPS=exports.RESET_USER=exports.UPDATE_USER=exports.SET_USER=void 0;var _extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e};exports.immediateUpdate=immediateUpdate,exports.update=update,exports.setUser=setUser,exports.updateUser=updateUser,exports.resetUser=resetUser,exports.resetPendingUserProps=resetPendingUserProps,exports.updatePendingUserProps=updatePendingUserProps;var _index=require("../../../npm/deep-equal/index.js"),_index2=_interopRequireDefault(_index),_index3=require("../../../npm/lodash.pick/index.js"),_index4=_interopRequireDefault(_index3),_index5=require("../../../npm/redux-batched-actions/lib/index.js"),_http=require("./http.js"),_http2=_interopRequireDefault(_http);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var SET_USER=exports.SET_USER="SET_USER",UPDATE_USER=exports.UPDATE_USER="UPDATE_USER",RESET_USER=exports.RESET_USER="RESET_USER",RESET_PENDING_USER_PROPS=exports.RESET_PENDING_USER_PROPS="RESET_PENDING_USER_PROPS",UPDATE_PENDING_USER_PROPS=exports.UPDATE_PENDING_USER_PROPS="UPDATE_PENDING_USER_PROPS",pendingUpdatePromise=void 0,pendingResolve=void 0,pendingTimeout=void 0,lastUpdateAttempt=void 0,EDITABLE_PROPERTIES=exports.EDITABLE_PROPERTIES=["givenName","surname","email","signedUpAt","properties"];function immediateUpdate(E){return function(e,t){var r=t(),n=r.config,i=n.appId,p=n.profile,s=r.user,o=r.pendingUserProps,d=pendingResolve;return pendingTimeout&&(clearTimeout(pendingTimeout),pendingResolve=pendingTimeout=null),lastUpdateAttempt=Date.now(),E=(0,_index4.default)(Object.assign({},o,E),EDITABLE_PROPERTIES),Object.keys(E).some(function(e){return!(0,_index2.default)(s[e],E[e])})&&p.enabled?e((0,_http2.default)("PUT","/apps/"+i+"/appusers/"+s.id,E)).then(function(){return e((0,_index5.batchActions)([resetPendingUserProps(),setUser(_extends({},s,E,{properties:_extends({},s.properties,E.properties)}))])),d&&d(t().user),t().user}):d?(d(s),pendingUpdatePromise):Promise.resolve(s)}}function update(s){return function(t,e){if(t(updatePendingUserProps(s)),!e().user.id)return Promise.resolve();var r=1e3*e().config.profile.uploadInterval,n=Date.now(),i=lastUpdateAttempt||0;if(pendingTimeout)return pendingUpdatePromise;if(r<n-i)return t(immediateUpdate());var p=r-(n-i);return pendingUpdatePromise=new Promise(function(e){pendingResolve=e,pendingTimeout=setTimeout(function(){e(t(immediateUpdate()))},p)})}}function setUser(e){return{type:SET_USER,user:e}}function updateUser(e){return{type:UPDATE_USER,properties:e}}function resetUser(){return{type:RESET_USER}}function resetPendingUserProps(){return{type:RESET_PENDING_USER_PROPS}}function updatePendingUserProps(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};return{type:UPDATE_PENDING_USER_PROPS,properties:(0,_index4.default)(e,EDITABLE_PROPERTIES)}}