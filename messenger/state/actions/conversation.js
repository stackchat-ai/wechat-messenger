"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.POST_MESSAGE_ATTRIBUTES=exports.SET_LAST_RECEIVED_MESSAGE_ID=exports.SET_FETCHING_MORE_MESSAGES_FROM_SERVER=exports.REMOVE_COMPLETED_UPLOAD=exports.INCREMENT_UNREAD_COUNT=exports.ADD_COMPLETED_UPLOAD=exports.RESET_UNREAD_COUNT=exports.RESET_CONVERSATION=exports.SET_CONVERSATION=exports.REPLACE_MESSAGE=exports.REMOVE_MESSAGE=exports.REJECT_MESSAGE=exports.SET_MESSAGES=exports.ADD_MESSAGES=exports.ADD_MESSAGE=void 0;var _extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var s=arguments[t];for(var n in s)Object.prototype.hasOwnProperty.call(s,n)&&(e[n]=s[n])}return e};exports.resetConversation=resetConversation,exports.setConversation=setConversation,exports.setMessages=setMessages,exports.addMessage=addMessage,exports.addCompletedUpload=addCompletedUpload,exports.removeCompletedUpload=removeCompletedUpload,exports.addMessages=addMessages,exports.rejectMessage=rejectMessage,exports.replaceMessage=replaceMessage,exports.incrementUnreadCount=incrementUnreadCount,exports.setFetchingMoreMessagesFromServer=setFetchingMoreMessagesFromServer,exports.setLastReceivedMessageId=setLastReceivedMessageId,exports.postSendMessage=postSendMessage,exports.completeUpload=completeUpload,exports.onMessageSendSuccess=onMessageSendSuccess,exports.addClientMessage=addClientMessage,exports.removeMessage=removeMessage,exports.sendMessage=sendMessage,exports.postPostback=postPostback,exports.sendPostback=sendPostback,exports.fetchMoreMessages=fetchMoreMessages,exports.handleConnectNotification=handleConnectNotification,exports.resetUnreadCount=resetUnreadCount,exports.resendMessage=resendMessage,exports.sendLocation=sendLocation,exports.uploadFile=uploadFile,exports.getMessagesWithoutThrottling=getMessagesWithoutThrottling,exports.getMessages=getMessages,exports.handleUserConversationResponse=handleUserConversationResponse,exports.startConversation=startConversation,exports.fetchUserConversation=fetchUserConversation;var _index=require("../../../npm/lodash.pick/index.js"),_index2=_interopRequireDefault(_index),_index3=require("../../../npm/redux-batched-actions/lib/index.js"),_appState=require("./app-state.js"),_user=require("./user.js"),_http=require("./http.js"),_http2=_interopRequireDefault(_http),_events=require("../../utils/events.js"),_delegate=require("../../utils/delegate.js"),_throttle=require("../../utils/throttle.js"),_client=require("../../utils/client.js"),_storage=require("../../utils/storage.js"),storage=_interopRequireWildcard(_storage),_errors=require("../../utils/errors.js"),_message=require("../../utils/message.js"),_notifications=require("../constants/notifications.js"),_message2=require("../constants/message.js"),_typing=require("./typing.js"),_index4=require("../../../npm/@stackchat/identity-utils/lib/index.js"),_mqtt=require("./mqtt.js"),_applyPseudoStaticIds=require("../../utils/applyPseudoStaticIds.js"),_awsSdkReactNative=require("../../lib/aws-sdk-react-native.js"),_awsSdkReactNative2=_interopRequireDefault(_awsSdkReactNative);function _interopRequireWildcard(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)Object.prototype.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t.default=e,t}function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _objectWithoutProperties(e,t){var s={};for(var n in e)0<=t.indexOf(n)||Object.prototype.hasOwnProperty.call(e,n)&&(s[n]=e[n]);return s}var MAX_UPLOAD_FILE_SIZE=1e7,ADD_MESSAGE=exports.ADD_MESSAGE="ADD_MESSAGE",ADD_MESSAGES=exports.ADD_MESSAGES="ADD_MESSAGES",SET_MESSAGES=exports.SET_MESSAGES="SET_MESSAGES",REJECT_MESSAGE=exports.REJECT_MESSAGE="REJECT_MESSAGE",REMOVE_MESSAGE=exports.REMOVE_MESSAGE="REMOVE_MESSAGE",REPLACE_MESSAGE=exports.REPLACE_MESSAGE="REPLACE_MESSAGE",SET_CONVERSATION=exports.SET_CONVERSATION="SET_CONVERSATION",RESET_CONVERSATION=exports.RESET_CONVERSATION="RESET_CONVERSATION",RESET_UNREAD_COUNT=exports.RESET_UNREAD_COUNT="RESET_UNREAD_COUNT",ADD_COMPLETED_UPLOAD=exports.ADD_COMPLETED_UPLOAD="ADD_COMPLETED_UPLOAD",INCREMENT_UNREAD_COUNT=exports.INCREMENT_UNREAD_COUNT="INCREMENT_UNREAD_COUNT",REMOVE_COMPLETED_UPLOAD=exports.REMOVE_COMPLETED_UPLOAD="REMOVE_COMPLETED_UPLOAD",SET_FETCHING_MORE_MESSAGES_FROM_SERVER=exports.SET_FETCHING_MORE_MESSAGES_FROM_SERVER="SET_FETCHING_MORE_MESSAGES_FROM_SERVER",SET_LAST_RECEIVED_MESSAGE_ID=exports.SET_LAST_RECEIVED_MESSAGE_ID="SET_LAST_RECEIVED_MESSAGE_ID",POST_MESSAGE_ATTRIBUTES=exports.POST_MESSAGE_ATTRIBUTES=["type","text","name","coordinates","avatarUrl","metadata","payload","mediaUrl","mediaType","clientMessageId"];function resetConversation(){return{type:RESET_CONVERSATION}}function setConversation(e){return{type:SET_CONVERSATION,conversation:e}}function setMessages(e){return{type:SET_MESSAGES,messages:e}}function addMessage(e){return{type:ADD_MESSAGE,message:e}}function addCompletedUpload(e){return{type:ADD_COMPLETED_UPLOAD,message:e}}function removeCompletedUpload(e){return{type:REMOVE_COMPLETED_UPLOAD,queryProps:_extends({},e)}}function addMessages(e){return{type:ADD_MESSAGES,messages:e,append:!(1<arguments.length&&void 0!==arguments[1])||arguments[1]}}function rejectMessage(e,t){return{type:REJECT_MESSAGE,queryProps:e,error:t}}function replaceMessage(e,t){return{type:REPLACE_MESSAGE,queryProps:e,message:t}}function incrementUnreadCount(){return{type:INCREMENT_UNREAD_COUNT}}function setFetchingMoreMessagesFromServer(e){return{type:SET_FETCHING_MORE_MESSAGES_FROM_SERVER,value:e}}function setLastReceivedMessageId(e){return{type:SET_LAST_RECEIVED_MESSAGE_ID,value:e}}var throttleMap={},throttlePerUser=function(e){return throttleMap[e]||(throttleMap[e]=new _throttle.Throttle),throttleMap[e]};function postSendMessage(a){return function(e,t){var s=t(),n=s.config.appId,r=s.user.id,o=s.conversation.id;return e((0,_http2.default)("POST","/conversations/sdk/apps/"+n+"/users/"+r+"/messages",{message:(0,_index2.default)(a,POST_MESSAGE_ATTRIBUTES),sender:{type:"endUser",client:(0,_client.getClientInfo)(n)},conversation:{id:o}}))}}function postUploadFile(i){return function(e,t){var s=t(),n=s.config.appId,r=s.user.id,o=i._blob;delete i._blob;var a=new FormData;return a.append("sender",JSON.stringify({type:"endUser",client:(0,_client.getClientInfo)(n)})),i.metadata&&a.append("message",JSON.stringify((0,_index2.default)(i,["metadata"]))),a.append("source",o,i._fileName),e((0,_http2.default)("POST","/apps/"+n+"/appusers/"+r+"/files",a))}}function onUploadComplete(a,e){var i=e.messageId;return function(e,t){var s=t().conversation,n=s.rejectedMessages,r=s.completedUploads.find(function(e){return e.id===i});if(Object.keys(n).includes(i)){var o=n[i];e(onUploadFailed(a,o))}else r?(e(removeCompletedUpload({id:r.id})),e(completeUpload(a,r))):e(replaceMessage({_clientId:a._clientId},Object.assign(a,{id:i})))}}function onUploadFailed(a,i){return function(e,t){var s=t().ui.text,n=(0,_errors.getUploadError)(i,s),r=n.shouldRemoveMessage,o=n.bannerText;r?(e((0,_appState.showErrorNotification)(o)),e(removeMessage({_clientId:a._clientId}))):e(onMessageSendFailure(a))}}function completeUpload(t,s){return function(e){return Promise.resolve(e(onMessageSendSuccess(t,s))).then(function(){return e(handleConnectNotification())})}}function onMessageSendSuccess(s,n){return function(e,t){return e((0,_appState.setShouldScrollToBottom)(!0)),void 0===t().conversation.messages.find(function(e){return n.id===e.id})&&(e(replaceMessage({clientMessageId:s.clientMessageId},n)),e(addMessage(n))),_events.observable.trigger("message:sent",(0,_message.filterClientProps)(s)),Promise.resolve()}}function onMessageSendFailure(s){return function(e){var t=[];s.sendStatus=_message2.SEND_STATUS.FAILED,t.push((0,_appState.setShouldScrollToBottom)(!0)),t.push(replaceMessage({_clientId:s._clientId},s)),e((0,_index3.batchActions)(t))}}function addClientMessage(r){return function(e,t){t().config.appId;var s=(new Date).getTime().toString(),n={id:s,type:"text",role:"endUser",_clientSent:(new Date).getTime()/1e3,clientMessageId:s,sendStatus:_message2.SEND_STATUS.SENDING,source:{id:r._clientId}};return"string"==typeof r?n.text=r:Object.assign(n,r),"string"==typeof r?n.text=r:Object.assign(n,r),e((0,_appState.setShouldScrollToBottom)(!0)),e(addMessage(n)),n}}function removeMessage(t){return function(e){e((0,_index3.batchActions)([(0,_appState.setShouldScrollToBottom)(!0),{type:REMOVE_MESSAGE,queryProps:_extends({},t)}]))}}function _getMessages(){var i=(0<arguments.length&&void 0!==arguments[0]?arguments[0]:{}).before;return function(t,e){var s=e(),n=s.user.id,r=s.config.appId,o=s.conversation.id,a={};i&&(a.before=i),(0,_http2.default)("GET","/conversations/sdk/apps/"+r+"/users/"+n+"/messages/"+o,a).then(function(e){t(e)})}}function sendChain(n,r){var e=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{},o=e.postSendHandler,a=e.postFailHandler;return function(t){(0,_typing.cancelTyping)();var e=t(startConversation("message:appUser"));o=o||function(e){return t(onMessageSendSuccess(r,e.message)).then(function(){return t(handleConnectNotification())})},a=a||function(e){return t(onMessageSendFailure(r,e))};var s=_delegate.delegate.beforeSend(r);return e.then(function(){return t(n(s))}).then(o).catch(a)}}function sendMessage(t){return function(e){return e(sendChain(postSendMessage,e(addClientMessage(t))))}}function postPostback(a){return function(e,t){var s=t(),n=s.user.id,r=s.config.appId,o=s.conversation.id;return e((0,_http2.default)("POST","/conversations/sdk/apps/"+r+"/users/"+n+"/messages/postback",_extends({},a,{sender:{type:"endUser",client:(0,_client.getClientInfo)(r)},conversation:{id:o}}))).catch(function(){e((0,_appState.showErrorNotification)(t().ui.text.actionPostbackError))})}}function sendPostback(s,n){return function(e){var t={postback:{payload:s}};return n&&(t.postback.metadata=n),e(postPostback(_delegate.delegate.beforePostbackSend(t)))}}function fetchMoreMessages(){return function(t,e){var s=e().conversation,n=s.hasMoreMessages,r=s.messages,o=s.isFetchingMoreMessagesFromServer;if(!n||o)return Promise.resolve();var a=r[0].timestamp;return t(setFetchingMoreMessagesFromServer(!0)),t(_getMessages({before:a})).then(function(e){return t((0,_index3.batchActions)([setConversation(_extends({},e.conversation,{hasMoreMessages:!!e.previous})),addMessages(e.messages,!1),setFetchingMoreMessagesFromServer(!1),(0,_appState.setFetchingMoreMessages)(!1)])),e})}}function handleConnectNotification(){var l=(0<arguments.length&&void 0!==arguments[0]?arguments[0]:{}).force;return function(e,t){var s=t(),n=s.user.clients,r=s.config.integrations,o=s.conversation.messages,a=s.ui.isConnectNotificationAllowed;if(l||a){var i=o.filter(function(e){return"endUser"===e.role}),d=hasLinkableChannels(r,n),c=getLinkableChannels(r).some(function(e){return CHANNEL_CATEGORIES[e]?CHANNEL_CATEGORIES[e].some(function(e){return isChannelLinked(n,e)}):isChannelLinked(n,e)});if(d&&!c)if(1===i.length)e((0,_appState.showConnectNotification)((i[0]._clientSent||i[0].timestamp)+1));else{for(var u=void 0,p=i.length-2;0<=p&&!u;p--){u=i[p].timestamp}if(l||u){var E=Date.now()/1e3;(l||E-u>=_notifications.CONNECT_NOTIFICATION_DELAY_IN_SECONDS)&&e((0,_appState.showConnectNotification)(E))}}}}}function resetUnreadCount(){return function(e,t){return 0<t().conversation.unreadCount&&e({type:RESET_UNREAD_COUNT}),Promise.resolve()}}function resendMessage(r){return function(t,e){var s=e().conversation.messages.find(function(e){return e._clientId===r});if(s){var n=Object.assign({},s,{sendStatus:_message2.SEND_STATUS.SENDING});return t(replaceMessage({_clientId:r},n)),"text"===n.type?t(sendChain(postSendMessage,n)):"location"===n.type?n.coordinates?t(sendChain(postSendMessage,n)):t(sendLocation(n)):t(sendChain(postUploadFile,n,{postSendHandler:function(e){t(onUploadComplete(n,e))},postFailHandler:function(e){t(onUploadFailed(n,e))}}))}}}function sendLocation(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};return function(r,e){var o=void 0;if((o=t._clientSent?t:r(addClientMessage(_extends({type:"location"},t)))).coordinates)return r(sendChain(postSendMessage,o));var a=e().ui.text.locationServicesDenied,i=e().ui.text.locationSecurityRestriction;return new Promise(function(t){var s=!1,n=setTimeout(function(){s=!0,r(onMessageSendFailure(o)),t()},15e3);navigator.geolocation.getCurrentPosition(function(e){clearTimeout(n),s||(Object.assign(o,{coordinates:{lat:e.coords.latitude,long:e.coords.longitude}}),r(replaceMessage({_clientId:o._clientId},o)),r(sendChain(postSendMessage,o)).then(t))},function(e){clearTimeout(n),s||("https:"!==parent.location.protocol?(setTimeout(function(){return alert(i)},100),r(removeMessage({_clientId:o._clientId}))):e.code===_message2.LOCATION_ERRORS.PERMISSION_DENIED?(setTimeout(function(){return alert(a)},100),r(removeMessage({_clientId:o._clientId}))):r(onMessageSendFailure(o)),t())},{timeout:15e3})})}}function _getFileDataUrl(n){return new Promise(function(e,t){var s=new FileReader;n&&s.readAsDataURL(n),s.addEventListener("load",function(){e(s.result)}),s.addEventListener("error",function(e){t(e)})})}function _getDataUrl(s){return s.type&&s.type.startsWith("image/")?new Promise(function(e,t){resizeImage(s).then(e).catch(function(){_getFileDataUrl(s).then(e).catch(t)})}):_getFileDataUrl(s)}function uploadFile(a){return function(r,e){var o=a.type&&a.type.startsWith("image/");if(a.size>MAX_UPLOAD_FILE_SIZE){var t=(0,_errors.getFileTooLargeText)(e().ui.text);return r((0,_appState.showErrorNotification)(t))}return _getDataUrl(a).then(function(e){var t=getBlobFromDataUrl(e,a.type),s=URL.createObjectURL(t),n=r(addClientMessage({_blob:t,_fileName:a.name,mediaType:a.type,mediaSize:a.size,mediaUrl:o?s:a.name,type:o?"image":"file"}));return r(sendChain(postUploadFile,n,{postSendHandler:function(e){r(onUploadComplete(n,e))},postFailHandler:function(e){r(onUploadFailed(n,e))}}))})}}function _getMessagesAndDispatchActions(t){return t(_getMessages()).then(function(e){return t((0,_index3.batchActions)([setConversation(_extends({},e.conversation,{hasMoreMessages:!!e.previous})),setMessages(e.messages)])),e})}function getMessagesWithoutThrottling(){return function(e){return _getMessagesAndDispatchActions(e)}}function getMessages(){return function(e,t){var s=t().user.id;return throttlePerUser(s).exec(function(){return _getMessagesAndDispatchActions(e)})}}function handleUserConversationResponse(e){var n=e.appUser,r=e.conversation,t=(e.hasPrevious,e.messages),o=void 0===t?[]:t;e.sessionToken,e.settings;return function(e,t){var s=[];return n&&s.push((0,_user.setUser)(n)),r&&s.push(setConversation(r)),0<o.length&&s.push(addMessages(o)),e((0,_index3.batchActions)(s)),(0,_mqtt.subscribeIot)(),Promise.resolve()}}var startConversationPromise=void 0;function startConversation(e){return function(t,e){if(startConversationPromise)return startConversationPromise;var s=e(),n=(s.user,s.config),r=n.appId,o=(n.identityPoolId,s.conversation.id);s.pendingUserProps;if(o)return Promise.resolve();var a={client:{id:(0,_index4.convertCognitoIdToUserId)(_awsSdkReactNative2.default.config.credentials.identityId)}},i=t((0,_http2.default)("POST","/users/sdk/apps/"+r+"/users",a)).then(function(e){var t=e.id,s=_objectWithoutProperties(e,["id"]),n=s.conversationIds[0];return storage.setItem(r+".conversationId",n),{appUser:_extends({id:t},s),conversation:{id:n}}});return startConversationPromise=i.then(function(e){return t(handleUserConversationResponse(e))}).then(function(){return startConversationPromise=void 0})}}function fetchUserConversation(){return function(t,e){var s=e(),n=s.user.id,r=s.config.appId,o=s.conversation.id;return t((0,_http2.default)("GET","/conversations/sdk/apps/"+r+"/users/"+n+"/messages/"+o)).then(function(e){e.forEach(function(e){"list"===e.type&&(e.text=e.text||"."),(0,_applyPseudoStaticIds.applyPseudoStaticIds)(e)}),t(handleUserConversationResponse({messages:e}))})}}