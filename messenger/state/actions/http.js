"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e};exports.stringifyGETParams=stringifyGETParams,exports.handleResponse=handleResponse,exports.default=http;var _urlJoin=require("../../../npm/url-join/lib/url-join.js"),_urlJoin2=_interopRequireDefault(_urlJoin),_awsSdkReactNative=require("../../lib/aws-sdk-react-native.js"),_awsSdkReactNative2=_interopRequireDefault(_awsSdkReactNative),_AwsV4Signer=require("../../utils/AwsV4Signer.js");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _objectWithoutProperties(e,t){var r={};for(var n in e)0<=t.indexOf(n)||Object.prototype.hasOwnProperty.call(e,n)&&(r[n]=e[n]);return r}function stringifyGETParams(e,r){var t=Object.keys(r).reduce(function(e,t){return null!==r[t]?e+"&"+encodeURIComponent(t)+"="+encodeURIComponent(r[t]):e},"");return t&&(e+=(~e.indexOf("?")?"&":"?")+t.substring(1)),e}function handleResponse(e){if(204===e.statusCode)return Promise.resolve();var t=-1<(e.header["Content-Type"]||"").indexOf("application/json");if(200<=e.statusCode&&e.statusCode<300){var r=e.data;return r&&t?r.data?r.data:r:Promise.resolve()}if(t){var n=e.data.errors,s=new Error("Error communicating with server");throw n&&0<n.length&&(s.message=n[0].code,s.code=n[0].code,s.status=n[0].status,s.response=e),s}var a=new Error(e.statusCode);return a.response=e,Promise.reject(a)}function http(a,o,i){var u=3<arguments.length&&void 0!==arguments[3]?arguments[3]:{},c=arguments[4],d=!(5<arguments.length&&void 0!==arguments[5])||arguments[5];return function(e,t){a=a.toUpperCase();var r=t().config,n=_extends({Accept:"application/json","Content-Type":"application/json",Host:"io-shared-apig.integration.io.dev.au.stackchat.com"},u),s={method:a,headers:n};i&&(i=Object.assign({},i),"GET"===a?o=stringifyGETParams(o,i):"POST"!==a&&"PUT"!==a||(s.body=JSON.stringify(i)));var l=(0,_urlJoin2.default)(c||r.apigBaseUrl,o);return d?_awsSdkReactNative2.default.config.credentials.getPromise().then(function(){n["X-Amz-Security-Token"]=_awsSdkReactNative2.default.config.credentials.sessionToken;var d=new _AwsV4Signer.AwsV4Signer({url:l,accessKeyId:_awsSdkReactNative2.default.config.credentials.accessKeyId,secretAccessKey:_awsSdkReactNative2.default.config.credentials.secretAccessKey,method:a,headers:n,region:_awsSdkReactNative2.default.config.region,service:"execute-api",body:s.body});return Promise.resolve().then(function(){var e=d.sign(),t=(e.url,e.headers),r=_objectWithoutProperties(e,["url","headers"]),n={},s=!0,a=!1,o=void 0;try{for(var i,u=t[Symbol.iterator]();!(s=(i=u.next()).done);s=!0){var c=i.value;c&&(n[c[0]]=c[1])}}catch(e){a=!0,o=e}finally{try{!s&&u.return&&u.return()}finally{if(a)throw o}}return new Promise(function(t){wx.request(_extends({url:l,header:n},r,{data:r.body,success:function(e){t(handleResponse(e))}}))})})}):new Promise(function(t){wx.request(_extends({url:l},s,{success:function(e){t(handleResponse(e))}}))})}}