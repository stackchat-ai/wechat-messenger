"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.assignGroups=exports.extractReplyActions=void 0;var _extends=Object.assign||function(e){for(var s=1;s<arguments.length;s++){var r=arguments[s];for(var t in r)Object.prototype.hasOwnProperty.call(r,t)&&(e[t]=r[t])}return e};exports.default=ConversationReducer;var _index=require("../../../npm/date-fns/is_same_day/index.js"),_index2=_interopRequireDefault(_index),_conversation=require("../actions/conversation.js"),ConversationActions=_interopRequireWildcard(_conversation),_common=require("../actions/common.js"),_message=require("../constants/message.js");function _interopRequireWildcard(e){if(e&&e.__esModule)return e;var s={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(s[r]=e[r]);return s.default=e,s}function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _defineProperty(e,s,r){return s in e?Object.defineProperty(e,s,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[s]=r,e}function _toConsumableArray(e){if(Array.isArray(e)){for(var s=0,r=Array(e.length);s<e.length;s++)r[s]=e[s];return r}return Array.from(e)}var INITIAL_STATE={messages:[],rejectedMessages:{},completedUploads:[],replyActions:{actions:[],message:null},unreadCount:0,hasMoreMessages:!1,isFetchingMoreMessagesFromServer:!1,lastReceivedMessageId:""},sortMessages=function(e){return e.sort(function(e,s){return(e.timestamp||e._clientSent)-(s.timestamp||s._clientSent)})},manageGroupsBetweenMessages=function(e,s,r){var t=0<=s&&e[s];if(t){var n="endUser"===r.role?r.role:r.name,a="endUser"===t.role?t.role:t.name,o=new Date(1e3*(t._clientSent||t.timestamp)),i=new Date(1e3*(r._clientSent||r.timestamp)),c=!(0,_index2.default)(o,i);t.role!==r.role||c?(t.lastInGroup=!0,r.firstMessageOfDay=c,r.firstInGroup=!0,r.shouldShowAuthor=!0):(n!==a?(r.firstInGroup=!0,r.shouldShowAuthor=!0):(t.shouldShowAvatar=!1,isCarousel(t)||isCarousel(r)?r.firstInGroup=!0:(t.lastInGroup=!1,t.shouldShowAvatar=!1)),r.firstMessageOfDay=!1),e[s]=t}else r.firstInGroup=!0,r.shouldShowAuthor=!0,r.firstMessageOfDay=!0;r.lastInGroup=!0,r.shouldShowAvatar=!0},isCarousel=function(e){return"carousel"===e.type||"list"===e.type},extractReplyActions=exports.extractReplyActions=function(e){var s=(0<arguments.length&&void 0!==e?e:{}).actions;return(void 0===s?[]:s).filter(function(e){var s=e.type;return"reply"===s||"locationRequest"===s})},addMessage=function(e,s){var r=extractReplyActions(s),t=s.text&&s.text.trim()||s.mediaUrl&&s.mediaUrl.trim();if(0<r.length&&!t)return e;if(s.id&&e.some(function(e){return e.id===s.id}))return e;var n=e.length;return manageGroupsBetweenMessages(e,n-1,s),sortMessages([].concat(_toConsumableArray(e),[s]))},removeMessage=function(e,s){var r=e.findIndex(function(e){return matchMessage(e,s)}),t=[].concat(_toConsumableArray(e.filter(function(e){return!matchMessage(e,s)})));if(0<=r)for(var n=0===r?r:r-1;n<t.length;n++)manageGroupsBetweenMessages(t,n-1,t[n]);return{messages:t,indexRemoved:r}},matchMessage=function(s,r){return Object.keys(r).every(function(e){return s[e]===r[e]})},rejectMessage=function(e,s){var r=void 0,t=e.find(function(e){return matchMessage(e,s)});if(!t)return e;t._clientId&&(r=_extends({},t,{sendStatus:_message.SEND_STATUS.FAILED,_clientId:t._clientId,lastInGroup:t.lastInGroup,firstInGroup:t.firstInGroup}));var n=e.indexOf(t);return[].concat(_toConsumableArray(e.slice(0,n)),[r],_toConsumableArray(e.slice(n+1)))},addRejected=function(e){var s=e.rejectedMessages,r=e.queryProps,t=e.error;return r.id&&t?_extends({},s,_defineProperty({},r.id,t)):s},replaceMessage=function(e,s,r){var t=e.find(function(e){return matchMessage(e,s)});if(!t)return{messages:e};t._clientId&&(r=_extends({},t,r,{_clientId:t._clientId,lastInGroup:t.lastInGroup,firstInGroup:t.firstInGroup,sendStatus:_message.SEND_STATUS.SENT}));var n=e.indexOf(t);return{messages:[].concat(_toConsumableArray(e.slice(0,n)),[r],_toConsumableArray(e.slice(n+1))),indexReplaced:n}},preserveFailedAndSendingMessages=function(e){return e.filter(function(e){return e.sendStatus===_message.SEND_STATUS.FAILED||e.sendStatus===_message.SEND_STATUS.SENDING})},cleanUpMessages=function(e){var n=[],a={};return e.forEach(function(e){var s=e.text&&!!e.text.trim()||e.mediaUrl&&!!e.mediaUrl.trim(),r=e.id?e.id+e.role+e.mediaType:e._clientSent+e.role+e.mediaType;e.id||(r=e._clientSent);var t=s||e.actions&&0<e.actions.filter(function(e){var s=e.type;return!_message.GLOBAL_ACTION_TYPES.includes(s)}).length||e.coordinates;r in a||!t||(a[r]=e,n.push(e))}),n},assignGroups=exports.assignGroups=function(r){return r.forEach(function(e,s){manageGroupsBetweenMessages(r,s-1,e)}),r};function ConversationReducer(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:INITIAL_STATE,s=arguments[1];switch(s.type){case _common.RESET:case ConversationActions.RESET_CONVERSATION:return _extends({},INITIAL_STATE);case ConversationActions.SET_CONVERSATION:return _extends({unreadCount:e.unreadCount,hasMoreMessages:e.hasMoreMessages},s.conversation,{messages:e.messages,completedUploads:e.completedUploads,rejectedMessages:e.rejectedMessages,replyActions:e.replyActions});case ConversationActions.SET_MESSAGES:return _extends({},e,{messages:assignGroups(sortMessages(cleanUpMessages([].concat(_toConsumableArray(s.messages),_toConsumableArray(preserveFailedAndSendingMessages(e.messages)))))),replyActions:{actions:extractReplyActions(s.messages[0]),message:s.messages[0]}});case ConversationActions.ADD_MESSAGES:return _extends({},e,{messages:assignGroups(sortMessages(cleanUpMessages(s.append?[].concat(_toConsumableArray(e.messages),_toConsumableArray(s.messages)):[].concat(_toConsumableArray(s.messages),_toConsumableArray(e.messages))))),replyActions:{actions:extractReplyActions(s.messages[0]),message:s.messages[0]}});case ConversationActions.ADD_MESSAGE:return Object.assign({},e,{messages:addMessage(e.messages,s.message),replyActions:{actions:extractReplyActions(s.message),message:s.message}});case ConversationActions.ADD_COMPLETED_UPLOAD:return Object.assign({},e,{completedUploads:[].concat(_toConsumableArray(e.completedUploads),[s.message])});case ConversationActions.REMOVE_COMPLETED_UPLOAD:return Object.assign({},e,{completedUploads:[].concat(_toConsumableArray(e.completedUploads.filter(function(e){return!matchMessage(e,s.queryProps)})))});case ConversationActions.REJECT_MESSAGE:return _extends({},e,{messages:sortMessages(rejectMessage(e.messages,s.queryProps)),rejectedMessages:addRejected({rejectedMessages:e.rejectedMessages,queryProps:s.queryProps,error:s.error})});case ConversationActions.REPLACE_MESSAGE:var r=replaceMessage(e.messages,s.queryProps,s.message),t=r.messages,n=r.indexReplaced,a=Object.assign({},e,{messages:sortMessages(t)});return n===t.length-1&&(a.replyActions={actions:extractReplyActions(s.message),message:s.message}),a;case ConversationActions.REMOVE_MESSAGE:var o=e.messages.length-1,i=e.messages[e.messages.length-2],c=removeMessage(e.messages,s.queryProps),u=c.messages,l=c.indexRemoved,d=Object.assign({},e,{messages:u});return l===o&&(d.replyActions={actions:i?extractReplyActions(i):[],message:i}),d;case ConversationActions.INCREMENT_UNREAD_COUNT:return Object.assign({},e,{unreadCount:e.unreadCount+1});case ConversationActions.RESET_UNREAD_COUNT:return Object.assign({},e,{unreadCount:0});case ConversationActions.SET_FETCHING_MORE_MESSAGES_FROM_SERVER:return Object.assign({},e,{isFetchingMoreMessagesFromServer:s.value});case ConversationActions.SET_LAST_RECEIVED_MESSAGE_ID:return Object.assign({},e,{lastReceivedMessageId:s.value});default:return e}}