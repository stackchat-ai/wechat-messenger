"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _dec,_class,_class2,_temp2,_extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var s=arguments[t];for(var a in s)Object.prototype.hasOwnProperty.call(s,a)&&(e[a]=s[a])}return e},_createClass=function(){function a(e,t){for(var s=0;s<t.length;s++){var a=t[s];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(e,t,s){return t&&a(e.prototype,t),s&&a(e,s),e}}(),_get=function e(t,s,a){null===t&&(t=Function.prototype);var o=Object.getOwnPropertyDescriptor(t,s);if(void 0===o){var n=Object.getPrototypeOf(t);return null===n?void 0:e(n,s,a)}if("value"in o)return o.value;var r=o.get;return void 0!==r?r.call(a):void 0},_index=require("../../../npm/@tarojs/taro-weapp/index.js"),_index2=_interopRequireDefault(_index),_index3=require("../../../npm/@tarojs/redux/index.js"),_message=require("../../utils/message.js"),_conversation=require("../../state/actions/conversation.js"),_message2=require("../../state/constants/message.js");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var MESSAGE_BASE_CLASS="sc-message",Message=(_dec=(0,_index3.connect)(function(e,t){var s=e.conversation.appMakerLastRead,a=e.ui,o=a.text,n=a.dateFnLocale,r=t.timestamp;return{dateFnLocale:n,clickToRetryText:o.clickToRetry,locationSendingFailedText:o.locationSendingFailed,messageTimestampFormat:o.messageTimestampFormat,tapToRetryText:o.tapToRetry,unsupportedMessageTypeText:o.unsupportedMessageType,appMakerHasRead:r<s}}))((_temp2=_class2=function(){function r(){var e,t,s;_classCallCheck(this,r);for(var a=arguments.length,o=Array(a),n=0;n<a;n++)o[n]=arguments[n];return(t=s=_possibleConstructorReturn(this,(e=r.__proto__||Object.getPrototypeOf(r)).call.apply(e,[this].concat(o)))).$usedState=["_$anonymousState__temp","_$anonymousState__temp2","anonymousState__temp3","anonymousState__temp4","anonymousState__temp5","anonymousState__temp6","anonymousState__temp7","$compid__5","$compid__6","$compid__7","$compid__8","$compid__9","$compid__10","isAppUser","isSupportedType","hasText","hasImage","hasCarousel","id","hasActions","sendStatus","SEND_STATUS","showStatusIndicator","shouldShowAuthor","shouldShowAvatar","actions","type","firstInGroup","lastInGroup","dispatch","_clientId","accentColor","avatarUrl","timestamp","unsupportedMessageTypeText","appMakerHasRead"],s.onLoadImage=function(){s.setState({hasImage:!0,hasTooBigImage:!1,hasImageFailure:!1})},s.onImageError=function(){s.setState({hasImage:!1,hasImageFailure:!0})},s.customComponents=["Avatar","TextMessage","ImageMessage","CarouselMessage","MessageStatus"],_possibleConstructorReturn(s,t)}return _inherits(r,_index.Component),_createClass(r,[{key:"_constructor",value:function(e){_get(r.prototype.__proto__||Object.getPrototypeOf(r.prototype),"_constructor",this).call(this,e),this._updateMessageState(this.props),this.$$refs=[]}},{key:"componentDidMount",value:function(){0===this.props.actions.length&&this._restyleBubble()}},{key:"_restyleBubble",value:function(){if(this.props.type===_message2.MESSAGE_TYPES.TEXT){var e=this._messageContent;if(e){var t=e.firstChild;if(!t)return;var s=getElementProperties(t),a=getElementProperties(e);if(!s||!a)return;var o=2*parseInt(a.fontSize);s.height>o&&s.width<a.width&&(e.style.width=s.width+parseInt(a.paddingLeft)+parseInt(a.paddingRight)+2+"px")}}}},{key:"_getContainerClasses",value:function(){var e=this.props.sendStatus,t=this.state,s=t.hasActions,a=t.hasImage,o=t.hasCarousel,n=["msg"];return(a||s)&&n.push("msg-image"),o&&n.push("msg-carousel"),[_message2.SEND_STATUS.SENDING,_message2.SEND_STATUS.FAILED].includes(e)&&n.push("msg-unsent"),n.join(" ")}},{key:"_getTextClasses",value:function(){var e=this.state,t=e.hasImageFailure,s=e.hasTooBigImage,a=e.lastItem,o=[MESSAGE_BASE_CLASS+"_item",MESSAGE_BASE_CLASS+"_text"];return("text"===a||t||s)&&o.push(MESSAGE_BASE_CLASS+"_item--last-item"),o.join(" ")}},{key:"_getRowClasses",value:function(){var e=this.props,t=e.firstInGroup,s=e.lastInGroup,a=this.state.isAppUser,o=["row"];return a?o.push("right-row"):o.push("left-row"),t&&(a?o.push("row-appuser-first"):o.push("row-appmaker-first")),s&&(a?o.push("row-appuser-last"):o.push("row-appmaker-last")),t||s||(a?o.push("row-appuser-middle"):o.push("row-appmaker-middle")),o.join(" ")}},{key:"_getActionClasses",value:function(){var e=["message-item"];return"actions"===this.state.lastItem&&e.push("last-item"),e.join(" ")}},{key:"_getLocationClasses",value:function(){var e=this.props.sendStatus,t=["message-item"];return"location"===this.state.lastItem&&t.push("last-item"),e===_message2.SEND_STATUS.SENDING?t.push("message-location-loading"):t.push("message-text"),t.join(" ")}},{key:"onMessageClick",value:function(){this.props.sendStatus===_message2.SEND_STATUS.FAILED&&this.props.dispatch((0,_conversation.resendMessage)(this.props._clientId))}},{key:"_updateMessageState",value:function(e){var t=e.mediaUrl,s=e.mediaSize,a=e.text,o=e.type,n=e.role,r=e.actions.filter(function(e){var t=e.type;return!_message2.GLOBAL_ACTION_TYPES.includes(t)}),i=a&&a.trim()&&a.trim()!==t,p=o===_message2.MESSAGE_TYPES.FILE,_=o===_message2.MESSAGE_TYPES.IMAGE&&s>_message2.IMAGE_MAX_BYTES,u=o===_message2.MESSAGE_TYPES.IMAGE&&!_,l=o===_message2.MESSAGE_TYPES.CAROUSEL||o===_message2.MESSAGE_TYPES.LIST,c=o===_message2.MESSAGE_TYPES.LOCATION,m="endUser"===n,h=!l&&0<r.length,d=void 0;h?d="actions":i||p?d="text":c&&(d="location");var g={hasText:i,hasFile:p,hasTooBigImage:_,hasImage:u,hasCarousel:l,hasLocation:c,hasActions:h,isAppUser:m,lastItem:d,hasImageFailure:!1};this.state?this.setState(g):this.state=g}},{key:"componentWillReceiveProps",value:function(e){this.props!==e&&this._updateMessageState(e)}},{key:"_createData",value:function(e,t,s){var a,o;this.__state=e||this.state||{},this.__props=t||this.props||{};var n=this.$prefix,r=(0,_index.genCompid)(n+"$compid__5"),i=(0,_index.genCompid)(n+"$compid__6"),p=(0,_index.genCompid)(n+"$compid__7"),_=(0,_index.genCompid)(n+"$compid__8"),u=(0,_index.genCompid)(n+"$compid__9"),l=(0,_index.genCompid)(n+"$compid__10"),c=this.__props,m=c.id,h=c.accentColor,d=c.avatarUrl,g=c.shouldShowAuthor,S=c.shouldShowAvatar,f=c.timestamp,y=c.sendStatus,T=c.showStatusIndicator,v=c.type,E=c.unsupportedMessageTypeText,A=c.appMakerHasRead,x=this.__state,C=x.hasText,I=x.hasActions,M=(x.hasFile,x.hasImageFailure),w=x.hasImage,b=x.hasTooBigImage,$=x.hasCarousel,k=x.isAppUser,j=(this.__props.actions.filter(function(e){var t=e.type;return!_message2.GLOBAL_ACTION_TYPES.includes(t)}),(0,_message.isSupportedMessageType)(v));j?C&&(o=this._getTextClasses(),_index.propsManager.set(_extends({},this.__props,{className:o}),p)):(a=this._getTextClasses(),_index.propsManager.set(_extends({},this.__props,{text:E,className:a}),i));w&&_index.propsManager.set(_extends({},this.__props,{onError:this.onImageError}),_);$&&_index.propsManager.set(_extends({},this.__props),u);var O={container:{},wrapper:{}};if((!w||b||M||I||C)&&k&&h&&(O.container.backgroundColor=O.container.borderLeftColor="#"+h),!m)return null;var L=this._getRowClasses(),P=(0,_index.internal_inline_style)(O.wrapper),G=this._getContainerClasses(),U=(0,_index.internal_inline_style)(O.container),R=I?this._getActionClasses():null;return k||_index.propsManager.set({messageId:m,hasImage:w,avatarUrl:d},r),y!==_message2.SEND_STATUS.FAILED&&T&&_index.propsManager.set({value:f,isAppUser:k,appMakerHasRead:A},l),Object.assign(this.__state,{_$anonymousState__temp:a,_$anonymousState__temp2:o,anonymousState__temp3:L,anonymousState__temp4:P,anonymousState__temp5:G,anonymousState__temp6:U,anonymousState__temp7:R,$compid__5:r,$compid__6:i,$compid__7:p,$compid__8:_,$compid__9:u,$compid__10:l,isAppUser:k,isSupportedType:j,hasText:C,hasImage:w,hasCarousel:$,id:m,hasActions:I,sendStatus:y,SEND_STATUS:_message2.SEND_STATUS,showStatusIndicator:T,shouldShowAuthor:g,shouldShowAvatar:S}),this.__state}}]),r}(),_class2.$$events=["onMessageClick"],_class2.defaultProps={actions:[],sendStatus:_message2.SEND_STATUS.SENT,showStatusIndicator:!1,isScrolledToBottom:!1},_class2.$$componentPath="messenger/components/message/Message",_class=_temp2))||_class;exports.default=Message,Component(require("../../../npm/@tarojs/taro-weapp/index.js").default.createComponent(Message));