"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _dec,_class,_class2,_temp2,_extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var o=arguments[t];for(var i in o)Object.prototype.hasOwnProperty.call(o,i)&&(e[i]=o[i])}return e},_createClass=function(){function i(e,t){for(var o=0;o<t.length;o++){var i=t[o];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(e,t,o){return t&&i(e.prototype,t),o&&i(e,o),e}}(),_get=function e(t,o,i){null===t&&(t=Function.prototype);var s=Object.getOwnPropertyDescriptor(t,o);if(void 0===s){var n=Object.getPrototypeOf(t);return null===n?void 0:e(n,o,i)}if("value"in s)return s.value;var r=s.get;return void 0!==r?r.call(i):void 0},_index=require("../../../npm/@tarojs/taro-weapp/index.js"),_index2=_interopRequireDefault(_index),_index3=require("../../../npm/react/index.js"),_index4=_interopRequireDefault(_index3),_index5=require("../../../npm/@tarojs/redux/index.js"),_conversation=require("../../state/actions/conversation.js"),_conversation2=require("../../state/reducers/conversation.js"),_app=require("../../state/constants/app.js"),_delegate=require("../../utils/delegate.js");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,o=Array(e.length);t<e.length;t++)o[t]=e[t];return o}return Array.from(e)}var BASE_CLASS="sc-conversation",Conversation=(_dec=(0,_index5.connect)(function(e){var t=e.appState,o=e.conversation,i=e.ui,s=i.text,n=i.isAtBottom,r=e.config,a=o.replyActions.message,l=void 0;return a?(l=_delegate.delegate.beforeDisplay(a)||{_isDeletedByBeforeDisplayDelegate:!0})._isDeletedByBeforeDisplayDelegate&&(l.id=a.id):l={},{messages:[].concat(_toConsumableArray(o.messages)),replyActionsOriginal:o.replyActions.actions,replyActionsParentMessage:l,embedded:t.widgetState===_app.WIDGET_STATE.EMBEDDED,widgetOpened:t.widgetState===_app.WIDGET_STATE.OPENED,shouldScrollToBottom:t.shouldScrollToBottom,isFetchingMoreMessages:t.isFetchingMoreMessages,isVoiceOnly:r.voiceConfig.voiceOnly,hasMoreMessages:o.hasMoreMessages,introHeight:t.introHeight,connectNotificationTimestamp:t.connectNotificationTimestamp,errorNotificationMessage:t.errorNotificationMessage,unreadCount:o.unreadCount,config:r,text:s,isAtBottom:n,typingIndicatorShown:t.typingIndicatorShown,typingIndicatorName:t.typingIndicatorName,isInitialized:t.isInitialized}}))((_temp2=_class2=function(){function r(){var e,t,o;_classCallCheck(this,r);for(var i=arguments.length,s=Array(i),n=0;n<i;n++)s[n]=arguments[n];return(t=o=_possibleConstructorReturn(this,(e=r.__proto__||Object.getPrototypeOf(r)).call.apply(e,[this].concat(s)))).$usedState=["anonymousState__temp","loopArray0","isInitialized","items","scrollOffset","dispatch","messages","config","replyActionsOriginal","replyActionsParentMessage","text","typingIndicatorName","typingIndicatorShown","isAtBottom"],o.config={component:!0},o.state={scrollOffset:0},o.previousMessageCount=0,o.fetchHistory=function(){var e=o.props,t=e.dispatch;e.messages;setTimeout(function(){t((0,_conversation.fetchMoreMessages)())},400)},o.scrollToBottom=function(){setTimeout(function(){var e=wx.createSelectorQuery().in(o.$scope);e.select(".sc-conversation_messages-container").scrollOffset(),e.exec(function(e){e[0]&&o.setState({scrollOffset:e[0].scrollHeight})})},100)},o.customComponents=["BeforeDisplayErrorBoundary","Message","TimestampHeader","ReplyActions","Spinner"],_possibleConstructorReturn(o,t)}return _inherits(r,_index.Component),_createClass(r,[{key:"_constructor",value:function(e){_get(r.prototype.__proto__||Object.getPrototypeOf(r.prototype),"_constructor",this).call(this,e),this.$$refs=[]}},{key:"componentDidUpdate",value:function(){this.props.isInitialized&&this.props.messages.length>this.previousMessageCount&&(this.previousMessageCount=this.props.messages.length,this.scrollToBottom())}},{key:"_createData",value:function(e,t,o){var r=this;this.__state=e||this.state||{},this.__props=t||this.props||{};var u=this.$prefix,i=this.__props,s=i.config,n=i.messages,g=(i.replyActionsOriginal,i.replyActionsParentMessage),a=i.text,l=i.typingIndicatorName,p=i.typingIndicatorShown,c=i.isAtBottom,d=i.isInitialized,_=(a.fetchingHistory,a.fetchHistory,s.colors),f=_.accentColor,m=_.linkColor,y=(s.backgroundImageUrl,n),h=n;if(_delegate.delegate.hasBeforeDisplay()){var v=n.reduce(function(e,t){var o=t.id&&t.id===g.id?g._isDeletedByBeforeDisplayDelegate?null:g:_delegate.delegate.beforeDisplay(t);return o&&(e.originalMessages.push(t),e.modifiedMessages.push(o)),e},{originalMessages:[],modifiedMessages:[]});y=v.originalMessages,h=v.modifiedMessages,(0,_conversation2.assignGroups)(y),(0,_conversation2.assignGroups)(h)}var M=[];if(h.forEach(function(e,t){var o=t===h.length-1,i=y[t];i.firstMessageOfDay&&M.push({type:"timestamp",props:{value:i._clientSent||e.timestamp,key:"ts-header-"+i.timestamp}});var s={accentColor:f,linkColor:m,onLoad:r.onMessageLoad,showStatusIndicator:o,isScrolledToBottom:c},n=e.lastInGroup;o&&"endUser"!==e.role&&p&&e.name===l&&(lastInGroup=!1),M.push({type:"message",originalMessage:i,modifiedMessage:e,messageProps:s,isLastInGroup:n,boundaryProps:{key:i._clientId||i.id,isMessageModifiedBeforeDisplay:!!e._isModifiedBeforeDisplay}})}),p){var x=!0;if(0<y.length){var C=y[y.length-1];"endUser"!==C.role&&C.name===l&&(x=!1)}M.push({type:"typing-indicator",props:{firstInGroup:x,key:"typing-indicator"}})}var A=(0,_conversation2.extractReplyActions)(this.__props.replyActionsParentMessage);0<A.length&&M.push({type:"reply-actions"});var S=[BASE_CLASS];d||S.push(BASE_CLASS+"--loading");var b=S.join(" "),O=d?M.map(function(e,t){var o=null,i=null,s=null,n=null;"message"===(e={$original:(0,_index.internal_get_original)(e)}).$original.type?(n=d?e.$original.originalMessage._clientId||e.$original.originalMessage.id:null,s=d?!!e.$original.modifiedMessage._isModifiedBeforeDisplay:null):"timestamp"===e.$original.type||"reply-actions"===e.$original.type&&(i=d?!!g._isModifiedBeforeDisplay:null,o=d?A.map(function(e){var t=e.text,o=e.iconUrl,i=e.type;return{text:t,iconUrl:o,metadata:e.metadata,payload:e.payload,type:i}}):null);var r=(0,_index.genCompid)(u+"CABCGcqAmh"+t);"message"===e.$original.type&&_index.propsManager.set({isMessageModifiedBeforeDisplay:s},r);var a=(0,_index.genCompid)(u+"szumkFBTOa"+t);"message"===e.$original.type&&_index.propsManager.set(_extends({},e.$original.messageProps,e.$original.modifiedMessage,{lastInGroup:e.$original.isLastInGroup}),a);var l=(0,_index.genCompid)(u+"XAMoaCOsqg"+t);_index.propsManager.set(_extends({},e.$original.props),l);var p=(0,_index.genCompid)(u+"arTlnHFgyo"+t);_index.propsManager.set({isMessageModifiedBeforeDisplay:i},p);var c=(0,_index.genCompid)(u+"uHjsuctZnM"+t);return _index.propsManager.set({choices:o},c),{$loopState__temp9:o,$loopState__temp7:i,$loopState__temp5:s,$loopState__temp3:n,$compid__0:r,$compid__1:a,$compid__2:l,$compid__3:p,$compid__4:c,$original:e.$original}}):[];return Object.assign(this.__state,{anonymousState__temp:b,loopArray0:O,isInitialized:d,items:M}),this.__state}}]),r}(),_class2.$$events=[],_class2.$$componentPath="messenger/components/conversation/Conversation",_class=_temp2))||_class;exports.default=Conversation,Component(require("../../../npm/@tarojs/taro-weapp/index.js").default.createComponent(Conversation));